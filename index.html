<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CE2407A ‚Äî Tutorials 1 & 2 (Q1‚ÄìQ3, Q6‚ÄìQ7)</title>
<style>
  :root{
    --bg:#0b132b; --card:#1c2541; --accent:#5bc0be;
    --accent2:#c5d86d; --text:#f0f3f7; --muted:#a8b3c7;
    --danger:#ff6b6b; --ok:#00c896; --warn:#ffd166;
    --kbd:#2b2f42; --code:#151a2b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
  a{color:var(--accent)}
  header{padding:18px 16px;background:linear-gradient(180deg,#0b132b 0%,#111a36 100%);
    border-bottom:1px solid rgba(255,255,255,.06); position:sticky; top:0; z-index:20}
  .container{max-width:1100px;margin:0 auto;padding:18px}
  h1{font-size:clamp(22px,3vw,28px);margin:0 0 2px 0}
  p.lead{color:var(--muted);margin:0}
  .score{font-weight:800}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);
    border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(91,192,190,.15);
    color:var(--accent);font-weight:600;font-size:12px;letter-spacing:.25px}
  label{display:block;font-weight:600;margin:10px 0 4px}
  input[type="number"], input[type="text"]{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
    background:#0e162f;color:var(--text);outline:none}
  input[type="number"]:focus, input[type="text"]:focus{border-color:var(--accent)}
  button{appearance:none;border:0;border-radius:10px;padding:10px 14px;background:var(--accent);
    color:#04131c;font-weight:700;cursor:pointer;transition:.15s transform ease, .15s filter ease;
    box-shadow:0 5px 16px rgba(0,0,0,.25)}
  button.secondary{background:#233058;color:#dee6ff}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.15);color:#e6edff}
  button.warn{background:var(--warn);color:#3a2c00}
  button:hover{filter:brightness(1.05)} button:active{transform:translateY(1px)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1 1 260px}
  .svg-wrap{background:#0f1833;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;margin-top:8px}
  svg{width:100%;height:300px;background:#0f1833;border-radius:8px}
  .small{font-size:12px;color:var(--muted)}
  .ok{color:var(--ok)} .bad{color:var(--danger)}
  .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent);margin:12px 0}
  .footer{color:var(--muted);font-size:12px;margin-top:20px}
  /* Wizard bits */
  .steps{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .step{border:1px solid rgba(255,255,255,.15);background:#12204b;color:#e6edff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .step.active{background:var(--accent);color:#04131c;border-color:transparent;font-weight:800}
  .wizard-nav{display:flex;gap:8px;justify-content:space-between;align-items:center;position:sticky;bottom:0;padding:10px 0;z-index:15}
  .hidden{display:none}
  .kbd{display:inline-block;background:var(--kbd);border:1px solid rgba(255,255,255,.12);border-bottom-color:rgba(0,0,0,.6);padding:2px 6px;border-radius:6px;font-family:ui-monospace,Consolas,Menlo,monospace}
  .group-label{font-size:12px;color:#b9c7ef;margin-left:6px}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:flex-start;gap:12px;justify-content:space-between">
    <div>
      <h1>CE2407A ‚Äî Tutorials 1 &amp; 2</h1>
      <p class="lead"><strong>Q1‚ÄìQ3</strong> (Tutorial 2) &amp; <strong>Q6‚ÄìQ7</strong> (Tutorial 1) with plots.</p>
    </div>
    <div class="score">Score: <span id="score">0</span> / 5</div>
  </div>
  <div class="container steps">
    <button class="step active" data-step="1" onclick="gotoStep(1)">Q1 <span class="group-label">T2</span></button>
    <button class="step" data-step="2" onclick="gotoStep(2)">Q2 <span class="group-label">T2</span></button>
    <button class="step" data-step="3" onclick="gotoStep(3)">Q3 <span class="group-label">T2</span></button>
    <button class="step" data-step="6" onclick="gotoStep(6)">Q6 <span class="group-label">T1</span></button>
    <button class="step" data-step="7" onclick="gotoStep(7)">Q7 <span class="group-label">T1</span></button>
  </div>
</header>

<div class="container">

  <!-- Q1 (Tutorial 2) -->
  <section id="q1" class="card">
    <div class="pill">Q1 ‚Äî Poisson‚ÄëBinomial (PMF &amp; CDF)</div>
    <p>Three independent bids: <strong>A</strong>, <strong>B</strong>, <strong>C</strong> with win probabilities P(A)=0.5, P(B)=0.8, P(C)=0.2. Let X be the total wins.</p>
    <div class="row">
      <div><label>p(A)</label><input type="number" step="0.01" id="q1_pA" value="0.5"></div>
      <div><label>p(B)</label><input type="number" step="0.01" id="q1_pB" value="0.8"></div>
      <div><label>p(C)</label><input type="number" step="0.01" id="q1_pC" value="0.2"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button onclick="q1_compute()">Compute &amp; Plot</button>
      <button class="secondary" onclick="q1_reset()">Reset</button>
    </div>
    <div class="svg-wrap"><h3>PMF of X</h3><svg id="q1_pmf" viewBox="0 0 640 300" role="img" aria-label="PMF bar chart"></svg></div>
    <div class="svg-wrap"><h3>CDF of X</h3><svg id="q1_cdf" viewBox="0 0 640 300" role="img" aria-label="CDF step chart"></svg></div>
    <div class="hr"></div>
    <div class="row">
      <div><label>P(X=0)</label><input id="q1_px0" type="number" step="0.0001"></div>
      <div><label>P(X=1)</label><input id="q1_px1" type="number" step="0.0001"></div>
      <div><label>P(X=2)</label><input id="q1_px2" type="number" step="0.0001"></div>
      <div><label>P(X=3)</label><input id="q1_px3" type="number" step="0.0001"></div>
    </div>
    <div class="row">
      <div><label>P(X ‚â§ 2)</label><input id="q1_le2" type="number" step="0.0001"></div>
      <div><label>P(0 &lt; X ‚â§ 2)</label><input id="q1_between" type="number" step="0.0001"></div>
    </div>
    <div class="row wizard-nav">
      <button class="ghost" onclick="gotoStep(2)">Next ‚Üí</button>
      <div style="display:flex; gap:8px">
        <button onclick="q1_check()">Check answers</button>
        <button class="ghost" onclick="q1_solution()">Show solution</button>
      </div>
    </div>
    <div id="q1_fb" class="small"></div>
  </section>

  <!-- Q2 (Tutorial 2) -->
  <section id="q2" class="card hidden">
    <div class="pill">Q2 ‚Äî Continuous RV on [10, 20]</div>
    <p>PDF: <code>f<sub>R</sub>(r) = c (r ‚àí 10) (20 ‚àí r)</code> for 10 ‚â§ r ‚â§ 20; 0 elsewhere. Derive the CDF and key statistics.</p>
    <div class="row">
      <div><label>Your c</label><input id="q2_c" type="number" step="0.0001"></div>
      <div><label>Your mean E[R]</label><input id="q2_mu" type="number" step="0.0001"></div>
      <div><label>Your median</label><input id="q2_med" type="number" step="0.0001"></div>
      <div><label>Your mode</label><input id="q2_mode" type="number" step="0.0001"></div>
    </div>
    <div class="row">
      <div><label>Your standard deviation</label><input id="q2_sd" type="number" step="0.0001"></div>
      <div><label>Your COV</label><input id="q2_cov" type="number" step="0.0001"></div>
      <div><label>Your skewness</label><input id="q2_skew" type="number" step="0.0001"></div>
    </div>

    <div class="svg-wrap"><h3>PDF f<sub>R</sub>(r)</h3><svg id="q2_pdf" viewBox="0 0 640 300" role="img" aria-label="PDF curve"></svg></div>
    <div class="svg-wrap"><h3>CDF F<sub>R</sub>(r)</h3><svg id="q2_cdf" viewBox="0 0 640 300" role="img" aria-label="CDF curve"></svg></div>
    <div class="row">
      <div><label>Evaluate F<sub>R</sub>(r) at r (10‚Äì20)</label><input id="q2_r" type="number" step="0.1" value="15" oninput="q2_evalCDF()"></div>
      <div style="display:flex;align-items:flex-end"><div id="q2_r_out" class="small">F_R(15) = 0.5000</div></div>
    </div>

    <div class="row wizard-nav">
      <button class="ghost" onclick="gotoStep(1)">‚Üê Back</button>
      <div style="display:flex; gap:8px">
        <button onclick="q2_check()">Check answers</button>
        <button class="ghost" onclick="q2_solution()">Show solution</button>
      </div>
      <button class="ghost" onclick="gotoStep(3)">Next ‚Üí</button>
    </div>
    <div id="q2_fb" class="small"></div>
  </section>

  <!-- Q3 (Tutorial 2) -->
  <section id="q3" class="card hidden">
    <div class="pill">Q3 ‚Äî Normal Congestion &amp; Growth</div>
    <p>Present peak-hour volume: <strong>N(200, 60¬≤)</strong>. Capacity <em>C</em> planes/hr. Mean increases linearly at 10% of current per year; COV remains constant.</p>
    <div class="row">
      <div><label>Capacity now, C</label><input id="q3_C" type="number" value="350"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button onclick="q3_compute()">Compute &amp; Plot</button>
      <button class="secondary" onclick="q3_reset()">Reset</button>
    </div>
    <div class="svg-wrap"><h3>Today: N(Œº=200, œÉ=60). Shaded P(X &gt; C)</h3><svg id="q3_now" viewBox="0 0 640 300" role="img" aria-label="Normal tail now"></svg></div>
    <div class="svg-wrap"><h3>In 10 years: N(Œº=400, œÉ=120). Shaded P(X &gt; C)</h3><svg id="q3_future" viewBox="0 0 640 300" role="img" aria-label="Normal tail in 10 years"></svg></div>

    <div class="hr"></div>
    <div class="row">
      <div><label>Your P(congestion today)</label><input id="q3_pnow" type="number" step="0.0001"></div>
      <div><label>Your P(congestion in 10 yrs at same C)</label><input id="q3_p10" type="number" step="0.0001"></div>
      <div><label>Your required C in 10 yrs for same service</label><input id="q3_reqC" type="number" step="0.1"></div>
    </div>
    <div class="row wizard-nav">
      <button class="ghost" onclick="gotoStep(2)">‚Üê Back</button>
      <div style="display:flex; gap:8px">
        <button onclick="q3_check()">Check answers</button>
        <button class="ghost" onclick="q3_solution()">Show solution</button>
      </div>
      <button class="ghost" onclick="gotoStep(6)">Next ‚Üí</button>
    </div>
    <div id="q3_fb" class="small"></div>
  </section>

<!-- Q6 (Tutorial 1) -->
  <section id="q6" class="card hidden">
    <div class="pill">Q6 ‚Äî Liquefaction risk under earthquake intensity mix</div>
    <p>Intensities L/M/H occur with relative frequencies (per year) of <em>w<sub>L</sub>=1</em>, <em>w<sub>M</sub>=0.1</em>, <em>w<sub>H</sub>=0.01</em>. Liquefaction probabilities by intensity are <em>p(Liq|L)=0.05</em>, <em>p(Liq|M)=0.20</em>, <em>p(Liq|H)=0.90</em>. Treat the next earthquake‚Äôs intensity as drawn from these weights and assume independence between events.</p>
    <div class="row">
      <div><label>Weight w<sub>L</sub> (per year)</label><input id="q6_wL" type="number" step="0.01" value="1"></div>
      <div><label>Weight w<sub>M</sub> (per year)</label><input id="q6_wM" type="number" step="0.01" value="0.1"></div>
      <div><label>Weight w<sub>H</sub> (per year)</label><input id="q6_wH" type="number" step="0.01" value="0.01"></div>
    </div>
    <div class="row">
      <div><label>p(Liq | L)</label><input id="q6_pL" type="number" step="0.001" value="0.05"></div>
      <div><label>p(Liq | M)</label><input id="q6_pM" type="number" step="0.001" value="0.20"></div>
      <div><label>p(Liq | H)</label><input id="q6_pH" type="number" step="0.001" value="0.90"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button onclick="q6_compute()">Compute &amp; Plot</button>
      <button class="secondary" onclick="q6_reset()">Reset</button>
    </div>

    <div class="svg-wrap"><h3>Intensity probabilities P(L), P(M), P(H)</h3><svg id="q6_probs" viewBox="0 0 640 300" role="img" aria-label="Intensity probabilities"></svg></div>
    <div class="svg-wrap"><h3>Contributions to P(liquefaction): P(L)p(Liq|L), etc.</h3><svg id="q6_contrib" viewBox="0 0 640 300" role="img" aria-label="Liquefaction contributions"></svg></div>

    <div class="hr"></div>
    <div class="row">
      <div><label>(a) P(L)</label><input id="q6_a" type="number" step="0.0001"></div>
      <div><label>(b) P(liquefaction in next quake)</label><input id="q6_b" type="number" step="0.0001"></div>
      <div><label>(c) P(survive next 3 quakes)</label><input id="q6_c" type="number" step="0.0001"></div>
      <div><label>(d) P(L | liquefaction)</label><input id="q6_d" type="number" step="0.0001"></div>
    </div>

    <div class="row wizard-nav">
      <button class="ghost" onclick="gotoStep(3)">‚Üê Back</button>
      <div style="display:flex; gap:8px">
        <button onclick="q6_check()">Check answers</button>
        <button class="ghost" onclick="q6_solution()">Show solution</button>
      </div>
      <button class="ghost" onclick="gotoStep(7)">Next ‚Üí</button>
    </div>
    <div id="q6_fb" class="small"></div>
  </section>

  <!-- Q7 (Tutorial 1) -->
  <section id="q7" class="card hidden">
    <div class="pill">Q7 ‚Äî Two-device detection &amp; accurate location</div>
    <p>Detectability of device A: <em>p<sub>A</sub>=0.8</em>; device B: <em>p<sub>B</sub>=0.9</em>. If detected by A alone, accurate location with prob. <em>0.7</em>; by B alone, <em>0.4</em>; by both, accurate with certainty.</p>
    <div class="row">
      <div><label>p<sub>A</sub> (detect by A)</label><input id="q7_pA" type="number" step="0.01" value="0.8"></div>
      <div><label>p<sub>B</sub> (detect by B)</label><input id="q7_pB" type="number" step="0.01" value="0.9"></div>
      <div><label>Accuracy if only A</label><input id="q7_accA" type="number" step="0.01" value="0.7"></div>
      <div><label>Accuracy if only B</label><input id="q7_accB" type="number" step="0.01" value="0.4"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button onclick="q7_compute()">Compute &amp; Plot</button>
      <button class="secondary" onclick="q7_reset()">Reset</button>
    </div>

    <div class="svg-wrap"><h3>Detection outcomes</h3><svg id="q7_detect" viewBox="0 0 640 300" role="img" aria-label="Detection breakdown"></svg></div>
    <div class="svg-wrap"><h3>Contributions to accurate location</h3><svg id="q7_accurate" viewBox="0 0 640 300" role="img" aria-label="Accurate location contributions"></svg></div>

    <div class="hr"></div>
    <div class="row">
      <div><label>(a) P(detected by ‚â•1 device)</label><input id="q7_a" type="number" step="0.0001"></div>
      <div><label>(b) P(detected by only one device)</label><input id="q7_b" type="number" step="0.0001"></div>
      <div><label>(c) P(accurately located)</label><input id="q7_c" type="number" step="0.0001"></div>
    </div>

    <div class="row wizard-nav">
      <button class="ghost" onclick="gotoStep(6)">‚Üê Back</button>
      <div style="display:flex; gap:8px">
        <button onclick="q7_check()">Check answers</button>
        <button class="ghost" onclick="q7_solution()">Show solution</button>
      </div>
    </div>
    <div id="q7_fb" class="small"></div>
  </section>

  <p class="footer">Sources: Tutorial Set #2 (Q1‚ÄìQ3) and Tutorial Set #1 (Q6‚ÄìQ7).</p>
</div>

<script>
/* ---------- Wizard / Score ---------- */
let CURRENT_STEP = 1;
let SCORE = 0;
function computeScore(){
  SCORE = (sessionStorage.getItem('done_q1')?1:0)
        + (sessionStorage.getItem('done_q2')?1:0)
        + (sessionStorage.getItem('done_q3')?1:0)
        + (sessionStorage.getItem('done_q6')?1:0)
        + (sessionStorage.getItem('done_q7')?1:0);
  document.getElementById('score').textContent=SCORE;
}
function gotoStep(n){
  CURRENT_STEP = n;
  ['q1','q2','q3','q6','q7'].forEach((id,i)=>{
    const map=[1,2,3,6,7];
    const step=map[i];
    document.getElementById(id).classList.toggle('hidden', step!==n);
  });
  document.querySelectorAll('.step').forEach(btn=>btn.classList.toggle('active', +btn.dataset.step===n));
  window.scrollTo({top:0,behavior:'smooth'});
}
computeScore();

/* ---------- Helpers ---------- */
const approx=(a,b,tol=1e-3)=>Math.abs((+a)-(+b))<=tol;
const fmt=p=>Number(p).toFixed(4);

/* ---------- Drawing helpers ---------- */
function drawBars(id, xs, ys){
  const svg=document.getElementById(id); svg.innerHTML='';
  const w=640,h=300,x0=40,y0=h-30,plotW=w-60,plotH=h-50,maxY=Math.max(...ys,1e-9)*1.15;
  const spacing=plotW/xs.length, bw=spacing*0.6;
  svg.innerHTML += `<line x1="40" x2="40" y1="10" y2="${y0}" stroke="#6f7ea3" />
                    <line x1="40" x2="${w-10}" y1="${y0}" y2="${y0}" stroke="#6f7ea3" />`;
  xs.forEach((x,i)=>{
    const xPos=x0+i*spacing+(spacing-bw)/2; const barH=(ys[i]/maxY)*plotH;
    svg.innerHTML += `<rect x="${xPos}" y="${y0-barH}" width="${bw}" height="${barH}" fill="#5bc0be" opacity="0.9" />`;
    svg.innerHTML += `<text x="${x0+i*spacing+spacing/2}" y="${y0+16}" text-anchor="middle" fill="#c0c9e8" font-size="12">${x}</text>`;
  });
  for(let i=0;i<=5;i++){const yy=y0-(i/5)*plotH; const val=(maxY*i/5);
    svg.innerHTML += `<text x="6" y="${yy+4}" fill="#c0c9e8" font-size="12">${val.toFixed(2)}</text>
                      <line x1="40" x2="${w-10}" y1="${yy}" y2="${yy}" stroke="rgba(255,255,255,.05)" />`;
  }
}
function drawStep(id, xs, Fxs){
  const svg=document.getElementById(id); svg.innerHTML='';
  const w=640,h=300,x0=40,y0=h-30,plotW=w-60,plotH=h-50;
  svg.innerHTML += `<line x1="40" x2="40" y1="10" y2="${y0}" stroke="#6f7ea3" />
                    <line x1="40" x2="${w-10}" y1="${y0}" y2="${y0}" stroke="#6f7ea3" />`;
  const xMin=xs[0], xMax=xs[xs.length-1];
  const sx=v=>x0+(v-xMin)/(xMax-xMin)*plotW, sy=v=>y0-(v/1)*plotH;
  for(let i=0;i<xs.length;i++){const x=xs[i],Fx=Fxs[i];
    const x1=sx(i?xs[i]-0.5:xMin), x2=sx(i<xs.length-1?xs[i+1]-0.5:xMax+0.5);
    svg.innerHTML += `<line x1="${x1}" x2="${x2}" y1="${sy(Fx)}" y2="${sy(Fx)}" stroke="#c5d86d" stroke-width="2.5" />`;
  }
  for(let i=0;i<=5;i++){const yy=y0-(i/5)*plotH;
    svg.innerHTML += `<text x="6" y="${yy+4}" fill="#c0c9e8" font-size="12">${(i/5).toFixed(1)}</text>
                      <line x1="40" x2="${w-10}" y1="${yy}" y2="${yy}" stroke="rgba(255,255,255,.05)" />`;
  }
}
function drawCurve(id, xmin, xmax, fn, ymax=null, color='#5bc0be', ylab='y'){
  const svg=document.getElementById(id); svg.innerHTML='';
  const w=640,h=300,x0=40,y0=h-30,plotW=w-60,plotH=h-60;
  let maxY = ymax==null? 0 : ymax;
  const N=400;
  if(ymax==null){for(let i=0;i<=N;i++){const x=xmin+(i/N)*(xmax-xmin); maxY=Math.max(maxY, fn(x));}}
  const sx=v=>x0+(v-xmin)/(xmax-xmin)*plotW, sy=v=>y0-(v/maxY)*plotH;
  svg.innerHTML += `<line x1="40" x2="40" y1="10" y2="${y0}" stroke="#6f7ea3" />
                    <line x1="40" x2="${w-10}" y1="${y0}" y2="${y0}" stroke="#6f7ea3" />
                    <text x="6" y="16" fill="#9fb2e2" font-size="12">${ylab}</text>`;
  let d='';
  for(let i=0;i<=N;i++){const x=xmin+(i/N)*(xmax-xmin); d+=(i?'L':'M')+sx(x)+','+sy(fn(x));}
  svg.innerHTML += `<path d="${d}" fill="none" stroke="${color}" stroke-width="2.5" />`;
  const steps=5;
  for(let i=0;i<=steps;i++){const xv=xmin+(i/steps)*(xmax-xmin);
    svg.innerHTML += `<text x="${sx(xv)}" y="${y0+16}" text-anchor="middle" fill="#c0c9e8" font-size="12">${xv.toFixed(0)}</text>`;}
  for(let i=0;i<=5;i++){const yy=y0-(i/5)*plotH; const val=(maxY*i/5);
    svg.innerHTML += `<text x="6" y="${yy+4}" fill="#c0c9e8" font-size="12">${val.toFixed(3)}</text>
                      <line x1="40" x2="${w-10}" y1="${yy}" y2="${yy}" stroke="rgba(255,255,255,.05)" />`;}
}
function drawNormalTail(id, mu, sd, C){
  const svg=document.getElementById(id); svg.innerHTML='';
  let xmin = mu - 4*sd, xmax = mu + 4*sd;
  xmin = Math.min(xmin, C - 0.5*sd); xmax = Math.max(xmax, C + 0.5*sd);
  const w=640,h=300,x0=40,y0=h-30,plotW=w-60,plotH=h-50;
  const maxY=(1/(sd*Math.sqrt(2*Math.PI)));
  const sx=v=>x0+(v-xmin)/(xmax-xmin)*plotW;
  const sy=v=>y0-(v/maxY)*plotH;
  // axes
  svg.innerHTML += `<line x1="40" x2="40" y1="10" y2="${y0}" stroke="#6f7ea3" />
                    <line x1="40" x2="${w-10}" y1="${y0}" y2="${y0}" stroke="#6f7ea3" />
                    <text x="6" y="16" fill="#9fb2e2" font-size="12">pdf</text>`;
  // curve + tail
  const N=360; let d='', tail='';
  for(let i=0;i<=N;i++){const x=xmin+(i/N)*(xmax-xmin); const y=(1/(sd*Math.sqrt(2*Math.PI)))*Math.exp(-0.5*((x-mu)/sd)**2);
    d+=(i?'L':'M')+sx(x)+','+sy(y);
    if(x>=C) tail+=(tail?'L':'M')+sx(x)+','+sy(y);
  }
  svg.innerHTML += `<path d="${d}" fill="none" stroke="#5bc0be" stroke-width="2.5" />`;
  if(tail){tail += `L ${sx(xmax)} ${sy(0)} L ${sx(C)} ${sy(0)} Z`;
    svg.innerHTML += `<path d="${tail}" fill="rgba(197,216,109,0.35)" stroke="none" />`; }
  // capacity line
  svg.innerHTML += `<line x1="${sx(C)}" x2="${sx(C)}" y1="10" y2="${y0}" stroke="#c5d86d" stroke-dasharray="4 4" stroke-width="2"/>`;
  svg.innerHTML += `<text x="${sx(C)+6}" y="18" fill="#c5d86d" font-size="12">C=${C}</text>`;
  // ticks
  const ticks=6;
  for(let i=0;i<=ticks;i++){const xv=xmin+(i/ticks)*(xmax-xmin);
    svg.innerHTML += `<text x="${sx(xv)}" y="${y0+16}" text-anchor="middle" fill="#c0c9e8" font-size="12">${xv.toFixed(0)}</text>`;}
}

/* ---------- Q1 logic ---------- */
function q1_pmf(ps){let pmf=[1]; for(const p of ps){const next=Array(pmf.length+1).fill(0);
  for(let k=0;k<pmf.length;k++){next[k]+=pmf[k]*(1-p); next[k+1]+=pmf[k]*p;} pmf=next;} return pmf;}
const q1_cum=pmf=>{let s=0; return pmf.map(v=>s+=v)};

function q1_compute(){
  const ps=[+q1_pA.value,+q1_pB.value,+q1_pC.value];
  const pmf=q1_pmf(ps); const cdf=q1_cum(pmf);
  drawBars('q1_pmf',[0,1,2,3],pmf); drawStep('q1_cdf',[0,1,2,3],cdf);
  q1_fb.textContent='Computed.';
}
function q1_reset(){
  ['q1_pA','q1_pB','q1_pC','q1_px0','q1_px1','q1_px2','q1_px3','q1_le2','q1_between'].forEach(id=>document.getElementById(id).value='');
  q1_pA.value=0.5; q1_pB.value=0.8; q1_pC.value=0.2;
  document.getElementById('q1_pmf').innerHTML=''; document.getElementById('q1_cdf').innerHTML=''; q1_fb.textContent='';
}
function q1_check(){
  const ps=[+q1_pA.value,+q1_pB.value,+q1_pC.value]; const pmf=q1_pmf(ps); const cdf=q1_cum(pmf);
  const target=[pmf[0],pmf[1],pmf[2],pmf[3],cdf[2],cdf[2]-pmf[0]];
  const ans=[q1_px0.value,q1_px1.value,q1_px2.value,q1_px3.value,q1_le2.value,q1_between.value];
  const ok=ans.every((x,i)=>approx(x,target[i],1e-3));
  q1_fb.innerHTML= ok?'<span class="ok">‚úÖ Correct.</span>':'<span class="bad">‚ùå Check your values. Hint: P(X‚â§2)=1‚àíP(X=3).</span>';
  if(ok && !sessionStorage.getItem('done_q1')){sessionStorage.setItem('done_q1','1'); computeScore();}
}
function q1_solution(){
  const ps=[+q1_pA.value,+q1_pB.value,+q1_pC.value]; const pmf=q1_pmf(ps); const cdf=q1_cum(pmf);
  q1_fb.innerHTML = `PMF: [${pmf.map(fmt).join(', ')}]; CDF: [${cdf.map(fmt).join(', ')}]; P(X‚â§2)=${fmt(cdf[2])}; P(0&lt;X‚â§2)=${fmt(cdf[2]-pmf[0])}.`;
}

/* ---------- Q2 logic ---------- */
const q2_c_true = 3/500;
function q2_fR(r){return (r>=10 && r<=20)? q2_c_true*(r-10)*(20-r) : 0;}
function q2_FR(r){
  if(r<=10) return 0;
  if(r>=20) return 1;
  return - (r**3)/500 + (9*r*r)/100 - (6*r)/5 + 5;
}
const q2_mu_true=15, q2_med_true=15, q2_mode_true=15, q2_sd_true=Math.sqrt(5), q2_cov_true=Math.sqrt(5)/15;
function q2_draw(){drawCurve('q2_pdf',10,20,q2_fR,null,'#5bc0be','f_R(r)'); q2_drawCDF();}
function q2_drawCDF(){
  const svg=document.getElementById('q2_cdf'); svg.innerHTML='';
  const w=640,h=300,x0=40,y0=h-30,plotW=w-60,plotH=h-60, xmin=10,xmax=20;
  const sx=v=>x0+(v-xmin)/(xmax-xmin)*plotW, sy=v=>y0-(v/1)*plotH;
  svg.innerHTML += `<line x1="40" x2="40" y1="10" y2="${y0}" stroke="#6f7ea3" />
                    <line x1="40" x2="${w-10}" y1="${y0}" y2="${y0}" stroke="#6f7ea3" />
                    <text x="6" y="16" fill="#9fb2e2" font-size="12">F_R(r)</text>`;
  const N=400; let d='';
  for(let i=0;i<=N;i++){const x=xmin+(i/N)*(xmax-xmin); d+=(i?'L':'M')+sx(x)+','+sy(q2_FR(x));}
  svg.innerHTML += `<path d="${d}" fill="none" stroke="#c5d86d" stroke-width="2.5" />`;
  const steps=5;
  for(let i=0;i<=steps;i++){const xv=xmin+(i/steps)*(xmax-xmin);
    svg.innerHTML += `<text x="${sx(xv)}" y="${y0+16}" text-anchor="middle" fill="#c0c9e8" font-size="12">${xv.toFixed(0)}</text>`;}
  for(let i=0;i<=5;i++){const yy=y0-(i/5)*plotH;
    svg.innerHTML += `<text x="6" y="${yy+4}" fill="#c0c9e8" font-size="12">${(i/5).toFixed(1)}</text>
                      <line x1="40" x2="${w-10}" y1="${yy}" y2="${yy}" stroke="rgba(255,255,255,.05)" />`;}
}
function q2_evalCDF(){
  const r=+document.getElementById('q2_r').value;
  const v=q2_FR(r);
  document.getElementById('q2_r_out').textContent=`F_R(${r}) = ${fmt(v)}`;
}
function q2_check(){
  const okC=approx(q2_c.value, q2_c_true, 5e-4);
  const okMu=approx(q2_mu.value, q2_mu_true, 1e-3);
  const okMed=approx(q2_med.value, q2_med_true, 1e-3);
  const okMode=approx(q2_mode.value, q2_mode_true, 1e-3);
  const okSd=approx(q2_sd.value, q2_sd_true, 5e-3);
  const okCov=approx(q2_cov.value, q2_cov_true, 5e-4);
  const okSk=approx(q2_skew.value, 0, 1e-3);
  const all=[okC,okMu,okMed,okMode,okSd,okCov,okSk].every(Boolean);
  document.getElementById('q2_fb').innerHTML = all? '<span class="ok">‚úÖ Correct.</span>' :
    '<span class="bad">‚ùå Some entries are off. Tip: this is a scaled Beta(2,2).</span>';
  if(all && !sessionStorage.getItem('done_q2')){sessionStorage.setItem('done_q2','1'); computeScore();}
}
function q2_solution(){
  const s=q2_sd_true, cov=q2_cov_true;
  document.getElementById('q2_fb').innerHTML = `c = 3/500 = 0.006. CDF (10‚â§r‚â§20): F_R(r) = -r¬≥/500 + 9r¬≤/100 ‚àí 6r/5 + 5. Mean=15, Median=15, Mode=15, œÉ=‚àö5‚âà${s.toFixed(4)}, COV‚âà${cov.toFixed(4)}, skewness=0.`;
}

/* ---------- Q3 logic ---------- */
function Phi(z){const s=z<0?-1:1; z=Math.abs(z)/Math.SQRT2;
  const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
  const t=1/(1+p*z); const y=1-(((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t)*Math.exp(-z*z);
  return 0.5*(1+s*y);}
function q3_params(){const mu0=200, sd0=60; const mu10=200+10*0.1*200; const cov=sd0/mu0; const sd10=cov*mu10; return {mu0,sd0,mu10,sd10};}
function q3_compute(){
  const {mu0,sd0,mu10,sd10}=q3_params(); const C=+q3_C.value;
  const zNow=(C-mu0)/sd0, z10=(C-mu10)/sd10;
  const pNow=1-Phi(zNow), p10=1-Phi(z10);
  drawNormalTail('q3_now', mu0, sd0, C); drawNormalTail('q3_future', mu10, sd10, C);
  document.getElementById('q3_fb').innerHTML = `P(congestion today)=${fmt(pNow)}; in 10 years at same C=${fmt(p10)}.`;
}
function q3_reset(){q3_C.value=350; q3_now.innerHTML=''; q3_future.innerHTML=''; q3_pnow.value=''; q3_p10.value=''; q3_reqC.value=''; q3_fb.textContent='';}
function q3_check(){
  const {mu0,sd0,mu10,sd10}=q3_params(); const C=+q3_C.value;
  const pNow=1-Phi((C-mu0)/sd0), p10=1-Phi((C-mu10)/sd10);
  const reqC = mu10 + sd10 * ((C-mu0)/sd0);
  const ok1=approx(q3_pnow.value, pNow, 3e-3);
  const ok2=approx(q3_p10.value,  p10,  5e-3);
  const ok3=Math.abs((+q3_reqC.value)-reqC)<=0.5;
  document.getElementById('q3_fb').innerHTML = (ok1&&ok2&&ok3)?'<span class="ok">‚úÖ Correct.</span>':'<span class="bad">‚ùå Not quite. Hint: keep the same z-quantile.</span>';
  if((ok1&&ok2&&ok3) && !sessionStorage.getItem('done_q3')){sessionStorage.setItem('done_q3','1'); computeScore();}
}
function q3_solution(){
  const {mu0,sd0,mu10,sd10}=q3_params(); const C=+q3_C.value;
  const zNow=(C-mu0)/sd0; const pNow=1-Phi(zNow); const p10=1-Phi((C-mu10)/sd10);
  const reqC = mu10 + sd10*zNow;
  document.getElementById('q3_fb').innerHTML = `Today: z=(C‚àí200)/60; with C=${C}, z=${zNow.toFixed(4)} ‚áí P‚âà${fmt(pNow)}. In 10 yrs: Œº=400, œÉ=120 ‚áí P‚âà${fmt(p10)}. To keep the same service: C=400+120¬∑z ‚âà ${reqC.toFixed(1)}.`;
}

/* ---------- Q6 logic ---------- */
function q6_params(){
  const wL=+q6_wL.value, wM=+q6_wM.value, wH=+q6_wH.value;
  const pL=+q6_pL.value, pM=+q6_pM.value, pH=+q6_pH.value;
  const S=wL+wM+wH;
  const PL = S>0? wL/S : 0, PM=S>0? wM/S : 0, PH=S>0? wH/S : 0;
  const Pliq = PL*pL + PM*pM + PH*pH;
  const Psurvive3 = Math.pow(1-Pliq,3);
  const PL_given_liq = Pliq>0? (PL*pL)/Pliq : 0;
  return {PL,PM,PH,Pliq,Psurvive3,PL_given_liq};
}
function q6_compute(){
  const {PL,PM,PH,Pliq,Psurvive3,PL_given_liq} = q6_params();
  drawBars('q6_probs', ['L','M','H'], [PL,PM,PH]);
  drawBars('q6_contrib', ['L','M','H'], [PL*(+q6_pL.value), PM*(+q6_pM.value), PH*(+q6_pH.value)]);
  q6_fb.textContent = `Computed: P(L)=${fmt(PL)}, P(M)=${fmt(PM)}, P(H)=${fmt(PH)}; P(liq)=${fmt(Pliq)}; P(survive 3)=${fmt(Psurvive3)}; P(L|liq)=${fmt(PL_given_liq)}.`;
}
function q6_reset(){
  q6_wL.value=1; q6_wM.value=0.1; q6_wH.value=0.01;
  q6_pL.value=0.05; q6_pM.value=0.20; q6_pH.value=0.90;
  ['q6_a','q6_b','q6_c','q6_d'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('q6_probs').innerHTML='';
  document.getElementById('q6_contrib').innerHTML='';
  q6_fb.textContent='';
}
function q6_check(){
  const {PL,Pliq,Psurvive3,PL_given_liq} = q6_params();
  const ans=[q6_a.value,q6_b.value,q6_c.value,q6_d.value];
  const tgt=[PL,Pliq,Psurvive3,PL_given_liq];
  const ok=ans.every((x,i)=>approx(x,tgt[i],1e-3));
  q6_fb.innerHTML = ok? '<span class="ok">‚úÖ Correct.</span>' :
    '<span class="bad">‚ùå Not quite. Hint: normalize the weights to get P(L), then use total probability and Bayes.</span>';
  if(ok && !sessionStorage.getItem('done_q6')){sessionStorage.setItem('done_q6','1'); computeScore();}
}
function q6_solution(){
  const {PL,PM,PH,Pliq,Psurvive3,PL_given_liq} = q6_params();
  q6_fb.innerHTML = `P(L)=w_L/(w_L+w_M+w_H)=${fmt(PL)}. Using total probability, P(liq)=P(L)p(Liq|L)+P(M)p(Liq|M)+P(H)p(Liq|H)=${fmt(Pliq)}. Independence ‚áí P(survive 3)=(1‚àíP(liq))¬≥=${fmt(Psurvive3)}. Bayes: P(L|liq)=[P(L)p(Liq|L)]/P(liq)=${fmt(PL_given_liq)}.`;
}

/* ---------- Q7 logic ---------- */
function q7_params(){
  const pA=+q7_pA.value, pB=+q7_pB.value, aA=+q7_accA.value, aB=+q7_accB.value;
  const Pnone=(1-pA)*(1-pB);
  const PonlyA=pA*(1-pB);
  const PonlyB=pB*(1-pA);
  const Pboth=pA*pB;
  const Pdet=1-Pnone;
  const PonlyOne=PonlyA+PonlyB;
  const Pacc=Pboth*1 + PonlyA*aA + PonlyB*aB;
  return {Pnone,PonlyA,PonlyB,Pboth,Pdet,PonlyOne,Pacc,aA,aB};
}
function q7_compute(){
  const {Pnone,PonlyA,PonlyB,Pboth,Pacc,aA,aB} = q7_params();
  drawBars('q7_detect', ['None','Only A','Only B','Both'], [Pnone,PonlyA,PonlyB,Pboth]);
  drawBars('q7_accurate', ['Only A','Only B','Both'], [PonlyA*aA,PonlyB*aB,Pboth*1]);
  q7_fb.textContent = `Computed: P(detected)=${fmt(1-Pnone)}; P(only one)=${fmt(PonlyA+PonlyB)}; P(accurate)=${fmt(Pacc)}.`;
}
function q7_reset(){
  q7_pA.value=0.8; q7_pB.value=0.9; q7_accA.value=0.7; q7_accB.value=0.4;
  ['q7_a','q7_b','q7_c'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('q7_detect').innerHTML='';
  document.getElementById('q7_accurate').innerHTML='';
  q7_fb.textContent='';
}
function q7_check(){
  const {Pnone,PonlyA,PonlyB,Pboth,Pdet,PonlyOne,Pacc}=q7_params();
  const ans=[q7_a.value,q7_b.value,q7_c.value];
  const tgt=[Pdet,PonlyOne,Pacc];
  const ok=ans.every((x,i)=>approx(x,tgt[i],1e-3));
  q7_fb.innerHTML = ok? '<span class="ok">‚úÖ Correct.</span>' :
    '<span class="bad">‚ùå Check your set algebra: (a) 1‚àí(1‚àípA)(1‚àípB); (b) pA(1‚àípB)+pB(1‚àípA); (c) add contributions with accuracies.</span>';
  if(ok && !sessionStorage.getItem('done_q7')){sessionStorage.setItem('done_q7','1'); computeScore();}
}
function q7_solution(){
  const {Pnone,PonlyA,PonlyB,Pboth,Pdet,PonlyOne,Pacc,aA,aB}=q7_params();
  q7_fb.innerHTML = `P(detected)=1‚àí(1‚àíp_A)(1‚àíp_B)=${fmt(Pdet)}. Only one: p_A(1‚àíp_B)+p_B(1‚àíp_A)=${fmt(PonlyOne)}. Accurate: P(both)¬∑1 + P(onlyA)¬∑${fmt(aA)} + P(onlyB)¬∑${fmt(aB)} = ${fmt(Pacc)}.`;
}

/* ---------- Boot ---------- */
gotoStep(1);
q1_compute();
q2_draw(); q2_evalCDF();
q3_compute();
q6_compute();
q7_compute();
</script>
  
<script>
/* === Minimal analytics emitter (CE2407A) === */
(function(){
  function sid(){
    let s = localStorage.getItem('ce2407_sid');
    if(!s){ s = 's_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
      localStorage.setItem('ce2407_sid', s); }
    return s;
  }
  function analyticsEndpoint(){
    try{
      // Reuse the AI‚ÄëCoach endpoint if user changed it in the UI
      const saved = JSON.parse(localStorage.getItem('aiCoach_ep') || '"https://ce2407-tutorial2.onrender.com/api/chat"');
      const base = (typeof saved === 'string' ? saved : 'https://ce2407-tutorial2.onrender.com/api/chat');
      if (/^https?:\/\//.test(base)) return base.replace(/\/api\/chat$/, '/api/track');
      return '/api/track';
    }catch{ return '/api/track'; }
  }
  window.track = function(event, payload={}){
    const active = document.querySelector('section.card:not(.hidden)');
    const sectionId = active ? active.id : null;
    fetch(analyticsEndpoint(), {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Session-Id': sid()
      },
      body: JSON.stringify({
        event,
        page: location.pathname + location.hash,
        step: (typeof window.CURRENT_STEP==='number' ? window.CURRENT_STEP : null),
        sectionId,
        sessionId: sid(),
        payload
      })
    }).catch(()=>{});
  };

  // Page/session signals
  document.addEventListener('visibilitychange', () =>
    track(document.visibilityState === 'hidden' ? 'page_hide' : 'page_show')
  );
  track('page_load', { title: document.title });

  // Wrap key functions you already have (compute/check/solution/step)
  const wrap = (name) => {
    if (typeof window[name] === 'function') {
      const orig = window[name];
      window[name] = function(...args){
        try { track('ui_' + name); } catch {}
        return orig.apply(this, args);
      };
    }
  };
  ['gotoStep','q1_compute','q1_check','q1_solution','q2_draw','q2_check','q2_solution',
   'q3_compute','q3_check','q3_solution','q6_compute','q6_check','q6_solution',
   'q7_compute','q7_check','q7_solution'].forEach(wrap);

  // AI‚ÄëCoach UI hooks (fab/close/quick buttons)
  document.addEventListener('click', (e)=>{
    if(e.target?.id === 'aiCoachFab') track('coach_toggle');
    if(e.target?.id === 'aiCoachClose') track('coach_close');
    const quick = e.target?.closest('.quick');
    if(quick) track('coach_quick', { label: quick.dataset.q });
  });

  // If you want to log each chat send (length only), add 1 line inside your coachAsk():
  // track('coach_send', { len: text?.length || 0, usingChatGPT: useBox.checked });
})();
</script>

<!-- === AI-COACH (CE2407A ‚Äî General) === -->
<style>
  /* Keep visual language consistent with CE2407A page */
  .coach-fab{
    position:fixed; right:22px; bottom:22px; width:56px; height:56px; border-radius:50%;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#04131c; display:flex; align-items:center; justify-content:center;
    font-weight:900; box-shadow:0 10px 30px rgba(0,0,0,.45); cursor:pointer; z-index:9999;
    border:1px solid rgba(255,255,255,.22);
  }
  .coach-panel{
    position:fixed; right:22px; bottom:86px; width:360px; max-height:66vh; display:none;
    background:var(--card); border:1px solid rgba(255,255,255,.12); border-radius:16px;
    box-shadow:0 14px 40px rgba(0,0,0,.5); z-index:9999; overflow:hidden; display:flex; flex-direction:column;
  }
  .coach-header{padding:10px 12px; background:#12204b; color:#e6edff; font-weight:700; font-size:14px;
    display:flex; justify-content:space-between; align-items:center}
  .coach-body{padding:10px; overflow:auto; gap:8px; display:flex; flex-direction:column}
  .coach-msg{background:#0f1833; border:1px solid rgba(255,255,255,.12); color:#e7efff;
    padding:8px 10px; border-radius:10px; font-size:13px;
    white-space: pre-wrap; /* NEW: preserve \n for MathJax-friendly layout */}
  .coach-self{align-self:flex-end; background:#0f1e3f}
  .coach-input{display:flex; gap:8px; padding:10px; border-top:1px solid rgba(255,255,255,.12); background:#0e162f}
  .coach-input input{flex:1; background:#0b132b; color:#e5e7eb; border:1px solid rgba(255,255,255,.18);
    border-radius:10px; padding:8px 10px; font-size:13px}
  .coach-input button{background:var(--accent); border:none; border-radius:10px; padding:8px 10px; color:#04131c; font-weight:800; cursor:pointer}
  .coach-quick{display:flex; gap:6px; flex-wrap:wrap; padding:8px 10px; border-top:1px dashed rgba(255,255,255,.16)}
  .quick{background:#0b1a36; border:1px solid rgba(255,255,255,.16); color:#cfe9ff; font-size:12px; padding:4px 6px; border-radius:8px; cursor:pointer}
  .coach-config{padding:8px 10px; border-top:1px solid rgba(255,255,255,.12); display:grid; gap:8px}
  .coach-config input{background:#0b132b;color:#e5e7eb;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:6px 8px;font-size:12px}
  .coach-config .tiny{font-size:11px;color:#a8b3c7}
  .coach-btn{background:#233058;color:#dee6ff;border:1px solid rgba(255,255,255,.18);padding:4px 8px;border-radius:8px;cursor:pointer}
</style>

<!-- FAB + PANEL -->
<div class="coach-fab" id="aiCoachFab" title="AI Coach">ü§ñ</div>
<div class="coach-panel" id="aiCoachPanel" aria-live="polite" aria-label="AI Coach panel">
  <div class="coach-header">
    <span>AI‚ÄëCoach (CE2407A)</span>
    <button id="aiCoachClose" class="coach-btn">Close</button>
  </div>

  <!-- Optional ChatGPT proxy (off by default) -->
  <div class="coach-config">
    <label style="display:flex; align-items:center; gap:6px; cursor:pointer; color:#cfe9ff; font-size:13px">
      <input id="aiUseChatGPT" type="checkbox"> Use ChatGPT for replies (via proxy)
    </label>
    <div id="aiChatCfg" style="display:none; gap:8px">
      <div>
        <div class="tiny">Proxy endpoint (recommended):</div>
        <input id="aiChatEndpoint" placeholder="https://ce2407-tutorial2.onrender.com/api/chat" value="https://ce2407-tutorial2.onrender.com/api/chat">
      </div>
      <div style="display:grid; gap:6px; grid-template-columns:1fr 1fr;">
        <div>
          <div class="tiny">Model</div>
          <input id="aiChatModel" value="gpt-4o-mini">
        </div>
        <div>
          <div class="tiny">Temperature</div>
          <input id="aiChatTemp" type="number" step="0.1" min="0" max="2" value="0.2">
        </div>
      </div>
    </div>
  </div>

  <div class="coach-body" id="aiCoachBody">
    <div class="coach-msg">Hi! I can give hints, explain approaches, or answer questions about the current problem. Try a quick button or type your own question.</div>
  </div>

  <div class="coach-quick">
    <button class="quick" data-q="Give me a hint.">Hint</button>
    <button class="quick" data-q="Explain the approach.">Approach</button>
    <button class="quick" data-q="Open the page‚Äôs Show solution button.">Show solution on page</button>
    <button class="quick" data-q="Define the key terms.">Definitions</button>
    <button class="quick" data-q="Check my steps.">Check my steps</button>
  </div>

  <div class="coach-input">
    <input id="aiCoachInput" placeholder="Ask about the current question‚Ä¶ (e.g., 'How do I find the CDF?')" />
    <button id="aiCoachSend">Send</button>
  </div>
</div>

<script>
(function(){
  /* ---------- Safe helpers ---------- */
  const $ = (id)=>document.getElementById(id);
  const escapeHTML = (s)=> String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const asHTML = (s)=> escapeHTML(s);
  const store = {
    get(k, d=null){ try{ const v = localStorage.getItem(k); return v===null? d : JSON.parse(v);}catch{ return d; } },
    set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
  };

  /* ---------- Elements ---------- */
  const fab=$('aiCoachFab'), panel=$('aiCoachPanel'), closeBtn=$('aiCoachClose');
  const body=$('aiCoachBody'), input=$('aiCoachInput'), send=$('aiCoachSend');
  const useBox=$('aiUseChatGPT'), cfgWrap=$('aiChatCfg'), ep=$('aiChatEndpoint'), model=$('aiChatModel'), temp=$('aiChatTemp');

  /* ---------- Load saved config ---------- */
  useBox.checked = !!store.get('aiCoach_use', false);
  cfgWrap.style.display = useBox.checked ? 'grid' : 'none';
  ep.value    = store.get('aiCoach_ep', 'https://ce2407-tutorial2.onrender.com/api/chat') || 'https://ce2407-tutorial2.onrender.com/api/chat';
  model.value = store.get('aiCoach_model', 'gpt-4o-mini') || 'gpt-4o-mini';
  temp.value  = store.get('aiCoach_temp', 0.2);

  /* ---------- UI wiring ---------- */
  fab.addEventListener('click', ()=>{ panel.style.display = (panel.style.display==='flex' ? 'none' : 'flex'); panel.style.flexDirection='column'; setTimeout(()=>body.scrollTop=body.scrollHeight,10); });
  closeBtn.addEventListener('click', ()=> panel.style.display='none');
  document.querySelectorAll('.coach-quick').forEach(qg=>{
    qg.addEventListener('click', (e)=>{
      const b=e.target.closest('.quick'); if(!b) return;
      coachAsk(b.dataset.q);
    });
  });
  send.addEventListener('click', ()=>coachAsk(input.value));
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ coachAsk(input.value); } });
  useBox.addEventListener('change', ()=>{
    cfgWrap.style.display = useBox.checked ? 'grid' : 'none';
    store.set('aiCoach_use', useBox.checked);
  });
  ep.addEventListener('change', ()=>store.set('aiCoach_ep', ep.value.trim()));
  model.addEventListener('change', ()=>store.set('aiCoach_model', model.value.trim()));
  temp.addEventListener('change', ()=>store.set('aiCoach_temp', parseFloat(temp.value)||0.2));

  /* ---------- Core ---------- */
  function appendMsg(msg, self=false){
  const div = document.createElement('div');
  div.className = 'coach-msg' + (self ? ' coach-self' : '');
  div.innerHTML = asHTML(msg);
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;

  // NEW: Typeset math for this message
  if (window.MathJax && window.__mathjax_ready && MathJax.typesetPromise) {
    MathJax.typesetPromise([div]).catch(()=>{});
  } else {
    // Queue until MathJax is ready
    window.__mathjax_pending = window.__mathjax_pending || [];
    window.__mathjax_pending.push(div);
  }
}

  function activeSection(){
    // Most robust: whichever <section> isn't hidden
    const sec = document.querySelector('section.card:not(.hidden)') || document.querySelector('section.card');
    if(!sec) return null;
    const title = (sec.querySelector('.pill')?.textContent || '').trim();
    const desc  = (sec.querySelector('p')?.textContent || '').trim();
    // collect filled inputs inside this section
    const inputs = Array.from(sec.querySelectorAll('input')).map(i=>({id:i.id||'(no id)', val:i.value}));
    return { id: sec.id, title, desc, inputs, sectionEl: sec };
  }

  function clickShowSolutionInPage(){
    const sec = activeSection()?.sectionEl;
    if(!sec) return false;
    // Prefer a button that contains "Show solution"
    const btn = Array.from(sec.querySelectorAll('button')).find(b=>/show solution/i.test(b.textContent||''));
    if(btn){ btn.click(); return true; }
    return false;
  }

  async function coachAsk(text){
    if(!text) return;
    appendMsg(text, true); input.value='';

    // Special quick: open page solution
    if(/show solution on page/i.test(text) || /open the page‚Äôs show solution/i.test(text)){
      const ok = clickShowSolutionInPage();
      appendMsg(ok ? 'Opened the page‚Äôs ‚ÄúShow solution‚Äù.' : 'Couldn‚Äôt find a ‚ÄúShow solution‚Äù button on this section.');
      return;
    }

    const ctx = buildContext(text);

    try{
      if(useBox.checked){
        const reply = await askChatGPT(ctx);
        appendMsg(reply || 'No content received from ChatGPT.');
      }else{
        appendMsg(localCoach(ctx));
      }
    }catch(err){
      console.error(err);
      appendMsg('I ran into an error. If ChatGPT mode is on, please check the proxy endpoint/model. Falling back to local hints‚Ä¶');
      appendMsg(localCoach(ctx));
    }
  }

  function buildContext(userText){
    const sec = activeSection();
    const step = (window.CURRENT_STEP!=null ? window.CURRENT_STEP : null);
    const filled = (sec?.inputs||[]).filter(x=>String(x.val).length>0);
    const filledPreview = filled.slice(0,12).map(x=>`${x.id}: ${x.val}`).join(', ');
    return {
      userText,
      step,
      sectionId: sec?.id||'',
      title: sec?.title||'',
      description: sec?.desc||'',
      inputsPreview: filledPreview
    };
  }

  function localCoach(ctx){
    // General, non-scene-specific hints (Q-agnostic)
    const lower = (ctx.userText||'').toLowerCase();
    const t = (ctx.title||'').toLowerCase();
    const d = (ctx.description||'').toLowerCase();

    // Universal replies
    if(lower.includes('hint')) return genericHint(t,d);
    if(lower.includes('approach')||lower.includes('how')||lower.includes('start')) return genericApproach(t,d);
    if(lower.includes('definition')||lower.includes('define')||lower.includes('terms')) return genericDefinitions(t,d);
    if(lower.includes('check')) return 'Share your steps or numbers and I‚Äôll point out what to verify (e.g., normalization, independence, or sign conventions).';

    // Default
    return genericHint(t,d);
  }

  function genericHint(t,d){
    // Lightly branch on topic keywords found in the visible card
    if(/poisson.*binomial|pmf|cdf/i.test(t+d)){
      return [
        'Think in terms of independent Bernoulli trials with different p‚Äôs.',
        'Use convolution (or a small DP) to get the PMF for X=0,1,2,3.',
        'CDF is the running sum of the PMF. Check that probabilities sum to 1.'
      ].join('\n');
    }
    if(/continuous.*/i.test(t+d)){
      return [
        'First, find the constant c by integrating the PDF over [10,20] and setting it to 1.',
        'Then integrate the PDF to get the CDF. Symmetry can reveal mean/median/mode.',
        'For spread, compute Var via E[R¬≤]‚àí(E[R])¬≤; œÉ=‚àöVar; COV=œÉ/Œº.'
      ].join('\n');
    }
    if(/normal|congestion|capacity/i.test(t+d)){
      return [
        'Translate the capacity into a z‚Äëscore: z=(C‚àíŒº)/œÉ.',
        'Congestion probability is the right tail 1‚àíŒ¶(z).',
        'If Œº scales and COV stays constant, œÉ scales with Œº; keep the same z for equal service.'
      ].join('\n');
    }
    if(/liquefaction|intensity|weights/i.test(t+d)){
      return [
        'Normalize the intensity weights to obtain P(L), P(M), P(H).',
        'Use total probability: P(liq)=Œ£ P(I)¬∑P(liq|I).',
        'For multiple events with independence, use powers; for P(L|liq), apply Bayes.'
      ].join('\n');
    }
    if(/two.*device|detection|accurate/i.test(t+d)){
      return [
        'Assume independence unless told otherwise.',
        'P(detected by ‚â•1)=1‚àí(1‚àípA)(1‚àípB). P(only one)=pA(1‚àípB)+pB(1‚àípA).',
        'Accurate location: sum contributions of each detection case times its accuracy.'
      ].join('\n');
    }
    return [
      'Read the variables and what is asked (probability vs. expectation vs. tail).',
      'Identify any independence assumptions and what must be normalized.',
      'Write down the governing formula, then plug in your values step‚Äëby‚Äëstep.'
    ].join('\n');
  }

  function genericApproach(t,d){
    return [
      '1) Restate the problem in your own words and list given values.',
      '2) Identify the governing relationship (e.g., normalization for PDFs, convolution for sums, Œ¶ for Normal tails, total probability/Bayes for mixtures).',
      '3) Compute intermediate pieces (constants, PMF entries, integrals, z‚Äëscores).',
      '4) Assemble the final quantity and sanity‚Äëcheck (units, bounds, sums to 1).'
    ].join('\n');
  }

  function genericDefinitions(t,d){
    return [
      'PMF: P(X=k) for discrete X; sums to 1.',
      'CDF: F(x)=P(X‚â§x); non‚Äëdecreasing; for discrete, it steps.',
      'PDF: f(x) integrates to 1; CDF is its integral.',
      'Œ¶(z): standard Normal CDF; z‚Äëscore = (x‚àíŒº)/œÉ.',
      'Law of total probability: P(A)=Œ£ P(A|B_i)P(B_i); Bayes updates P(B_i|A).'
    ].join('\n');
  }

  async function askChatGPT(ctx){
    const system = [
      'You are a concise, encouraging AI coach for CE2407A tutorials.',
      'Give step‚Äëby‚Äëstep guidance and hints first; show full derivations only when asked.',
      'Respect the problem‚Äôs notation; keep equations compact; check for normalization and independence.'
    ].join(' ');
    const content = [
      `Current section: ${ctx.sectionId} | Title: ${ctx.title}`,
      `Description: ${ctx.description}`,
      ctx.inputsPreview ? `Student inputs: ${ctx.inputsPreview}` : 'Student inputs: (none filled)',
      `Student question: ${ctx.userText}`
    ].join('\n');

    const r = await fetch((ep.value||'https://ce2407-tutorial2.onrender.com/api/chat').trim(), {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        model: (model.value||'gpt-4o-mini'),
        temperature: parseFloat(temp.value||'0.2'),
        system,
        messages: [
          { role:'system', content: system },
          { role:'user',   content: content }
        ]
      })
    });
    if(!r.ok) throw new Error('Proxy error '+r.status);
    const data = await r.json();
    return data.reply || '';
  }
})();
</script>
<!-- === /AI-COACH === -->
  
<!-- MathJax v3 (TeX ‚Üí CHTML) -->
<script>
  // Configure before loading the script
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      packages: {'[+]': ['noerrors', 'noundefined']}
    },
    options: {
      // Don't typeset inside these tags
      skipHtmlTags: ['script','noscript','style','textarea','pre','code']
    },
    // We'll queue messages that arrive before MathJax is ready
    startup: {
      typeset: false,
      ready: () => {
        MathJax.startup.defaultReady();
        window.__mathjax_ready = true;
        const pend = window.__mathjax_pending || [];
        if (pend.length) {
          MathJax.typesetPromise(pend).catch(() => {});
          window.__mathjax_pending = [];
        }
      }
    }
  };
</script>
<script id="MathJax-script" defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

</body>
</html>










